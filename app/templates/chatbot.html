<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="{% static 'app/css/chatbot3.css' %}">
  <link rel="stylesheet" href="{% static 'app/font-awesome/css/all.css' %}">
  <link href={{catalogo.logo.url}} rel="icon">
  <link href={{catalogo.logo.url}} rel="apple-touch-icon">
  <title>ChatBot</title>
  <style>
    @font-face {
      font-family: Ubuntu;
      src: url(../static/app/fonts/ubuntu/Ubuntu-Regular.ttf)
    }
    
    @font-face {
      font-family: ADLaM Display;
      src: url(../static/app/fonts/ADLaM_Display/ADLaMDisplay-Regular.ttf)
    }

    #chat-messages {
      background-image: url({{catalogo.fondo_chatbot.url}}) !important;
    }
  </style>
</head>
<body>
  <div id="chat-container" class="col-12 col-sm-6">
    <div id="chat-header">
      <a href="javascript:history.back()" id="back"><i class="fas fa-arrow-left"></i></a>
      <img src="{% static 'app/svg/robot-wink-fill.svg' %}" width="40" height="40" alt="Review" style="filter: invert(100%);">
      <span id="nombre-usuario">Asistente Virtual</span>
      <span id="estado-usuario">Escribiendo...</span>
      <div id="login-container" style="margin-left: auto;">
        <button class="btn plain-txt" id="html-btn"><i class="fas fa-font"></i></button>
        <a href={% url 'login_chatbot' %} id="login-button" class=""><i class="fas fa-user-circle"></i></a>
      </div>
    </div>
    
    <div id="chat-messages">
    </div>

    <form id="chat-form">
      <input type="text" id="msg" class="form-control" placeholder="Escribe un mensaje...">
      <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i></button>
    </form>
  </div>
  
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script>
    const estadoUsuario = document.getElementById('estado-usuario');

    let puntos = 0;
    setInterval(() => {
      puntos++;
      if (puntos > 3) {
        puntos = 0;
      }
      estadoUsuario.textContent = `Escribiendo${'.'.repeat(puntos)}`;
    }, 500);

    const html_btn = document.querySelector('#html-btn');
    html_btn.addEventListener("click", function(){
      if (html_btn.classList.contains('html-txt')) {
        html_btn.innerHTML = '<i class="fas fa-font"></i>';
        html_btn.classList.remove('html-txt');
        html_btn.classList.add('plain-txt');
      } else if (html_btn.classList.contains('plain-txt')) {
        html_btn.innerHTML = '<i class="fas fa-code"></i>';
        html_btn.classList.remove('plani-txt');
        html_btn.classList.add('html-txt');
      }
    });
    $(document).ready(function(){
      const typing = document.querySelector('#estado-usuario');
      $('#chat-form').submit(function(e){
        var ahora = new Date();
        var hora = ahora.getHours();
        var minutos = ahora.getMinutes();
        var segundos = ahora.getSeconds();
        var ampm = hora >= 12 ? 'PM' : 'AM';
        hora = hora % 12;
        hora = hora ? hora : 12;
        minutos = minutos < 10 ? '0' + minutos : minutos;
        segundos = segundos < 10 ? '0' + segundos : segundos;
        var strHora = hora + ':' + minutos + ':' + segundos + ' ' + ampm;

        typing.style.visibility = 'visible';
        e.preventDefault();
        var msg = $('#msg').val();
        $('#chat-messages').append('<p class="mb-0 user-sms">' + msg + '<small>' + strHora + '</small></p>');
        $('#msg').val('');
        if (html_btn.classList.contains('html-txt')){
          msg += ". (Responde a este mensaje en formato html)"
        }
        else {
          msg += ". (No respondas a este mensaje en formato html)"
        }
        $.ajax({
            url: "{% url 'chatbot' %}",
            method: 'POST',
            data: {Body: msg},
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            success: function(response){
              if (response.status === 'success') {
                typing.style.visibility = 'hidden';
                $('#chat-messages').append('<p class="mb-0 bot-sms">' + response.text + '<small>' + 
                response.time + '</small></p>');
                $("#chat-messages").scrollTop($("#chat-messages")[0].scrollHeight);
              } else {
                typing.style.visibility = 'hidden';
                alert('Error: ' + response.error);
              }
            },
            error: function(xhr, status, error){
              typing.style.visibility = 'hidden';
              console.error(error);
              alert('Error al enviar el mensaje');
            }
        });
      });
    });
  </script>
</body>
</html>